default:
  image: cirrusci/flutter:2.0.3


stages: 
  - build-debug
  - build-release
  - release


build-debug-android:
  environment: android
  stage: build-debug
  except:
    - master
  script:
    - flutter clean
    - flutter pub get
    - flutter pub run flutter_launcher_icons:main
    - flutter pub run flutter_native_splash:create
    - flutter build appbundle --debug


build-release-android:
  environment: android
  stage: build-release
  only:
    - master
  before_script:
    - cat ${KEYSTORE_FILE} | base64 --decode > android/app/key.jks
    - | 
      cat > android/key.properties << EOF
      storePassword=${KEYSTORE_PASSWORD}
      keyPassword=${KEYSTORE_KEY_PASSWORD}
      keyAlias=${KEY_ALIAS}
      storeFile=key.jks
      EOF
  script:
    - flutter clean
    - flutter pub get
    - flutter pub run flutter_launcher_icons:main
    - flutter pub run flutter_native_splash:create
    - flutter build appbundle --release --build-name=1.1.${CI_PIPELINE_IID} --build-number=${CI_PIPELINE_IID}
  artifacts: 
    paths: 
      - build/app/outputs/bundle/release/app-release.aab


create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build-release-android
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
      when: never                                  # Do not run this job when a tag is created manually
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH  # Run this job when commits are pushed or merged to the default branch
  script:
    - echo 'running release_job for $TAG'
  release:
    name: '1.1.${CI_PIPELINE_IID}+${CI_PIPELINE_IID}'
    description: '${CI_COMMIT_TITLE}: ${COMMIT_DESCRIPTION}'
    tag_name: '1.1.${CI_PIPELINE_IID}+${CI_PIPELINE_IID}'
    ref: '1.1.${CI_PIPELINE_IID}+${CI_PIPELINE_IID}'
